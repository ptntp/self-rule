name: Auto Merge Rules from Config

on:
  schedule:
    - cron: '0 5 * * *'  # 每天台灣時間下午 1:00（UTC 05:00）
  workflow_dispatch:  # 允許手動執行
  push:
    branches:
      - main
    paths:
      - 'china_reject.list'  # 當配置文件變更時自動執行

jobs:
  merge-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Read config and merge rules
        run: |
          # 檢查配置文件是否存在
          if [ ! -f "china_reject.list" ]; then
            echo "❌ 錯誤：找不到 china_reject.list 配置文件"
            exit 1
          fi
          
          # 創建輸出文件頭部
          echo "# 中國媒體攔截規則集（自動合併）" > reject.list
          echo "# 自動生成時間: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z')" >> reject.list
          echo "# 規則源配置: china_reject.list" >> reject.list
          echo "" >> reject.list
          
          # 讀取配置文件並提取有效的 URL
          echo "📋 正在讀取規則源配置..."
          URLS=$(grep -v '^#' china_reject.list | grep -v '^$' | grep 'http')
          
          if [ -z "$URLS" ]; then
            echo "❌ 錯誤：配置文件中沒有找到有效的 URL"
            exit 1
          fi
          
          # 計算 URL 數量
          URL_COUNT=$(echo "$URLS" | wc -l)
          echo "✅ 找到 $URL_COUNT 個規則源"
          echo "" >> reject.list
          echo "# 本次合併包含 $URL_COUNT 個規則源：" >> reject.list
          
          # 創建臨時文件
          > temp.list
          > temp_sources.txt
          
          # 逐個下載規則集
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          while IFS= read -r url; do
            # 提取規則集名稱（從 URL 中）
            RULE_NAME=$(echo "$url" | sed 's/.*\/\([^\/]*\)\.list/\1/')
            
            echo "⬇️  正在下載: $RULE_NAME"
            echo "#   - $RULE_NAME ($url)" >> reject.list
            
            # 下載並處理規則
            if curl -fsSL --connect-timeout 10 --max-time 30 "$url" 2>/dev/null | grep -v '^#' | grep -v '^$' >> temp.list; then
              echo "   ✅ 成功: $RULE_NAME"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "$url" >> temp_sources.txt
            else
              echo "   ⚠️  失敗: $RULE_NAME (可能網絡問題或 URL 無效)"
              FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            
          done <<< "$URLS"
          
          echo "" >> reject.list
          echo "# 下載成功: $SUCCESS_COUNT 個 | 下載失敗: $FAIL_COUNT 個" >> reject.list
          echo "" >> reject.list
          
          # 去重並排序
          echo "🔄 正在去重和排序..."
          BEFORE_COUNT=$(wc -l < temp.list)
          sort -u temp.list >> reject.list
          AFTER_COUNT=$(grep -v '^#' reject.list | grep -v '^$' | wc -l)
          DUPLICATE_COUNT=$((BEFORE_COUNT - AFTER_COUNT))
          
          # 清理臨時文件
          rm temp.list temp_sources.txt
          
          # 顯示統計信息
          echo ""
          echo "📊 合併統計："
          echo "   - 規則源數量: $URL_COUNT"
          echo "   - 下載成功: $SUCCESS_COUNT"
          echo "   - 下載失敗: $FAIL_COUNT"
          echo "   - 合併前規則數: $BEFORE_COUNT"
          echo "   - 去重後規則數: $AFTER_COUNT"
          echo "   - 重複規則數: $DUPLICATE_COUNT"
          echo ""
          
          # 在文件末尾添加統計信息（註釋形式）
          echo "" >> reject.list
          echo "# ====== 統計信息 ======" >> reject.list
          echo "# 最終規則數: $AFTER_COUNT 條" >> reject.list
          echo "# 重複已去除: $DUPLICATE_COUNT 條" >> reject.list
          echo "# 下載成功率: $SUCCESS_COUNT/$URL_COUNT" >> reject.list
          
          if [ $FAIL_COUNT -gt 0 ]; then
            echo "⚠️  警告：有 $FAIL_COUNT 個規則源下載失敗"
          fi
          
          echo "✅ 合併完成！"
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reject.list
          
          # 檢查是否有變更
          if git diff --staged --quiet; then
            echo "📝 沒有變更，跳過提交"
          else
            RULE_COUNT=$(grep -v '^#' reject.list | grep -v '^$' | wc -l)
            TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "🤖 Auto update: $RULE_COUNT rules - $TIMESTAMP"
            git push
            echo "✅ 規則已更新並推送到倉庫"
          fi
          
      - name: Summary
        if: always()
        run: |
          echo "### 📊 執行摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "reject.list" ]; then
            RULE_COUNT=$(grep -v '^#' reject.list | grep -v '^$' | wc -l)
            echo "✅ **合併成功**" >> $GITHUB_STEP_SUMMARY
            echo "- 最終規則數: **$RULE_COUNT** 條" >> $GITHUB_STEP_SUMMARY
            echo "- 更新時間: $(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **合併失敗**" >> $GITHUB_STEP_SUMMARY
          fi
